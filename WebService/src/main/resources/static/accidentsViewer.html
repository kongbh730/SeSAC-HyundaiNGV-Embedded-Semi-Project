<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Accident Viewer</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            background-color: #f4f4f5;
        }
        header {
            background-color: #ffffff;
            border-bottom: 1px solid #ddd;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 {
            font-size: 20px;
            margin: 0;
        }
        .tabs {
            display: flex;
            gap: 8px;
            padding: 16px 24px;
        }
        .tab-button {
            padding: 8px 16px;
            background-color: #e4e4e7;
            border-radius: 4px;
            text-decoration: none;
            color: black;
            font-weight: bold;
        }
        .tab-button.active {
            background-color: #6366f1;
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            margin: 24px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #eee;
        }
    </style>
</head>
<body>

<header>
    <h1>ğŸš§ Accident Viewer</h1>
</header>

<audio id="alert-sound" src="/chime.mp3" preload="auto"></audio>

<div class="tabs">
    <a href="vehicleViewer.html" class="tab-button">Vehicles</a>
    <a href="accidentsViewer.html" class="tab-button active">Accidents</a>
</div>

<table id="accident-table" style="margin: 0 24px;">
    <thead>
    <tr>
        <th>ID</th>
        <th>ì°¨ëŸ‰</th>
        <th>ìš´ì „ì</th>
        <th>ìœ„ì¹˜</th>
        <th>ë‚ ì§œ</th>
        <th>ìƒíƒœ</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<div id="custom-alert" style="
  display: none;
  position: fixed;
  top: 40px;
  right: 40px;
  background-color: #ef4444;
  color: white;
  padding: 16px 24px;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  font-weight: bold;
  z-index: 9999;
  transition: opacity 0.3s ease;
"></div>

<script>
    const vehicleMap = {};
    let accidentList = [];

    function showCustomAlert(message) {
        const alertBox = document.getElementById("custom-alert");
        alertBox.textContent = message;
        alertBox.style.display = "block";
        alertBox.style.opacity = "1";

        const audio = document.getElementById("alert-sound");
        if (audio) {
            audio.currentTime = 0;
            audio.play().catch(e => console.warn("ğŸ”‡ ì˜¤ë””ì˜¤ ìë™ ì¬ìƒ ì°¨ë‹¨ë¨:", e));
        }

        setTimeout(() => {
            alertBox.style.opacity = "0";
            setTimeout(() => {
                alertBox.style.display = "none";
            }, 300);
        }, 3000);
    }

    // ìƒˆë¡œê³ ì¹¨ í›„ alert ë©”ì‹œì§€ ìˆëŠ” ê²½ìš°
    window.addEventListener("DOMContentLoaded", () => {
        const pendingAlert = localStorage.getItem("pendingAlert");
        if (pendingAlert) {
            showCustomAlert(pendingAlert);
            localStorage.removeItem("pendingAlert");
        }
    });

    function renderAccidentTable() {
        const tbody = document.querySelector('#accident-table tbody');
        tbody.innerHTML = '';

        // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        accidentList.sort((a, b) => new Date(b.datetime) - new Date(a.datetime));

        accidentList.forEach(accident => {
            const v = vehicleMap[accident.vehicleId] || {};
            const row = document.createElement('tr');
            row.innerHTML = `
        <td>${accident.id || '-'}</td>
        <td>${v.name || accident.vehicleId}</td>
        <td>${v.driver || '-'}</td>
        <td>${accident.location}</td>
        <td>${accident.datetime || '-'}</td>
        <td>${accident.status || 'Reported'}</td>
      `;
            tbody.appendChild(row);
        });
    }

    // ì´ˆê¸° ë¡œë”©
    fetch('/api/vehicles')
        .then(res => res.json())
        .then(vehicles => {
            vehicles.forEach(v => vehicleMap[v.id] = v);
            return fetch('/api/accidents');
        })
        .then(res => res.json())
        .then(accidents => {
            accidentList = accidents;
            renderAccidentTable();
        });

    // WebSocket ì‚¬ê³  ìˆ˜ì‹ 
    const socket = new WebSocket("ws://192.168.100.122:8081/ws/accidents");

    socket.onmessage = function(event) {
        const message = event.data;
        console.log("ğŸš¨ ì‚¬ê³  ë©”ì‹œì§€ ìˆ˜ì‹ :", message);

        if (message.startsWith("accident:")) {
            const vehicleId = parseInt(message.split(":")[1]);
            const vehicle = vehicleMap[vehicleId];
            const driver = vehicle?.driver || "ìš´ì „ì";
            const vehicleName = vehicle?.name || `vehicle-${vehicleId}`;

            // âœ… ì•Œë¦¼ ë©”ì‹œì§€ë¥¼ ì €ì¥í•˜ê³  ìƒˆë¡œê³ ì¹¨
            localStorage.setItem("pendingAlert", `ğŸš¨ ${driver}ì˜ ì°¨ëŸ‰ ${vehicleName}(${vehicleId})ì—ì„œ ì‚¬ê³ ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤! ğŸš¨`);
            location.reload();
        }
    };

    socket.onerror = function(error) {
        console.error("WebSocket ì˜¤ë¥˜:", error);
    };
</script>

</body>
</html>
